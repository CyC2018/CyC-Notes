# 计算机网络 - 网络层

## 概述

网络层是整个互联网的核心，其设计理念是保持简单，使其能够高效地处理多种类型的网络。网络层主要提供无连接（connectionless）和尽最大努力（best-effort）的数据报服务。通过使用互联网协议（IP），网络层能够将不同类型的物理网络连接起来，使它们在逻辑上看起来像是一个统一的网络。

与 IP 协议协同工作的还有三种重要的协议：

- **地址解析协议 ARP (Address Resolution Protocol)**：用于将 IP 地址映射到 MAC 地址。
- **网际控制报文协议 ICMP (Internet Control Message Protocol)**：用于错误消息报告和诊断网络通信故障。
- **网际组管理协议 IGMP (Internet Group Management Protocol)**：用于管理主机组及其多播组成员。

## IP 数据报格式

IP 数据报的结构非常重要，理解其格式有助于我们更好地进行网络编程和调试。下图是标准的 IP 数据报格式：

![IP 数据报格式](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/85c05fb1-5546-4c50-9221-21f231cdc8c5.jpg)

### 各字段说明：

- **版本 (Version)**: 指示 IP 协议的版本，目前主要为 IPv4（值为 4）和 IPv6（值为 6）。
  
- **首部长度 (Header Length)**: 该字段表明 IP 首部的长度，以 32 位字为单位，最大值为 15（即 60 字节）。

- **区分服务 (Differentiated Services)**: 用于提供不同的服务质量（QoS），通常在普通情况下不使用。

- **总长度 (Total Length)**: 表示整个 IP 数据报的长度（包括首部和数据部分），最大值为 65535 字节。

- **生存时间 (Time to Live, TTL)**: TTL 是一个用于限制数据报在网络中存活时间的机制，以跳数（hops）为单位，当 TTL 值减为 0 时，数据报将被丢弃。

- **协议 (Protocol)**: 指示数据部分使用的协议类型，例如 TCP（传输控制协议）、UDP（用户数据报协议）、ICMP（网际控制报文协议）等。

- **首部检验和 (Header Checksum)**: 用于确保 IP 数据报在传输过程中没有损坏。每经过一个路由器，检验和需要重新计算。

- **标识 (Identification)**: 在分片时用于唯一标识相同的数据报，使得接收端能够识别哪些分片是同一数据报的组成部分。

- **片偏移 (Fragment Offset)**: 指示分片相对于原始数据报的位置，以 8 字节为单位，帮助接收端将分片重组为完整的数据报。

## IP 地址编址方式

IP 地址的编址方式可以分为三个阶段：

### 1. 分类 (Classful Addressing)

IP 地址分为 A、B、C 类，结构为网络号和主机号两个部分。不同类别的网络号长度是固定的。

**IP 地址 = {网络号, 主机号}**

![IP 地址分类](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/cbf50eb8-22b4-4528-a2e7-d187143d57f7.png)

### 2. 子网划分 (Subnetting)

通过在主机号部分划分出一部分作为子网号，用以进一步细分大网，实现更灵活的网络管理。

**IP 地址 = {网络号, 子网号, 主机号}**

使用子网需要配置子网掩码，子网掩码是用来标识网络部分和主机部分的。例如，B 类地址的默认子网掩码为 255.255.0.0。

### 3. 无分类编址 (CIDR)

CIDR（Classless Inter-Domain Routing，无类别域间路由）摒弃了传统的 A、B、C 类划分，采用网络前缀和主机号进行编码，根据需要可自由调整网络前缀的长度。

**IP 地址 = {网络前缀, 主机号}**

CIDR 使用斜杠表示法来表示网络前缀的长度，例如 `128.14.35.7/20` 表示前 20 位为网络前缀。

通过 CIDR，多个网络可以被聚合到一起，从而减少路由表中的条目数量，这种技术称为**路由聚合**或**构成超网**。

## 地址解析协议 ARP

在网络层实现主机间通信的同时，链路层负责具体链路之间的通信。因此，IP 数据报中的源地址和目的地址在整个数据传输过程中不变，而 MAC 地址会根据链路的不同而变化。

![ARP 协议示意图](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/66192382-558b-4b05-a35d-ac4a2b1a9811.jpg)

ARP 的主要功能是将 IP 地址转换为 MAC 地址。每个主机都有一个 ARP 高速缓存，存储本局域网上所有主机的 IP 地址与 MAC 地址的映射关系。

以下是 ARP 的工作流程：
1. 当主机 A 想与主机 B 通信时，如果其 ARP 高速缓存中没有 B 的 MAC 地址，它将发送一个广播的 ARP 请求，询问 "谁拥有这个 IP 地址"。
2. 收到请求的主机 B 会回复一个含有其 MAC 地址的 ARP 响应。
3. 主机 A 记录下这个映射关系，以便将来的数据传输。

![ARP 请求与响应](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/b9d79a5a-e7af-499b-b989-f10483e71b8b.jpg)

## 网际控制报文协议 ICMP

ICMP 是 IP 协议的一部分，旨在增强数据报转发的效率和成功交付率。ICMP 消息可以分为两大类：差错报告和询问。

![ICMP 报文](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e3124763-f75e-46c3-ba82-341e6c98d862.jpg)

### 1. Ping

Ping 是 ICMP 的重要应用，主要用于测试两台主机之间的连通性。其基本原理是发送 ICMP Echo 请求报文，若目的主机可达，则会回复 ICMP Echo 回应报文。

### 2. Traceroute

Traceroute 是用于追踪数据包从源点到目的地的路径。其工作机制如下：

- 源主机首先发送 TTL 值为 1 的 IP 数据报。
- 路由器收到数据报时将 TTL 减 1，若 TTL 归零，则丢弃该数据报，并发送一个 ICMP 超时差错报告回源主机。
- 接着，源主机发送 TTL 值加 1 的数据报，重复上述过程，直到数据包到达目的地（在目的地返回 ICMP 报文）。

通过这种方式，源主机可以获取沿途经过的各个路由器的 IP 地址及其响应时间。

## 虚拟专用网 VPN

由于公用 IP 地址资源的紧缺，许多机构所申请到的 IP 地址远少于其内部设备数量。VPN（Virtual Private Network，虚拟专用网）允许机构在公用互联网中创建专属的私有网络。

VPN 利用公用互联网作为专用网之间的通信载体。机构内部的主机只与同一机构的其他主机通信，实质上形成了一个专用的虚拟网络。

下图展示了一个 VPN 的工作流程：

![VPN 工作示意图](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1556770b-8c01-4681-af10-46f1df69202c.jpg)

## 网络地址转换 NAT

在专用网中，内部主机使用私有 IP 地址进行互联，而要与外部网络通信时，需要通过网络地址转换（NAT）机制，将其私有 IP 地址转换为公有 IP 地址。

传统的 NAT 机制将内网主机的私有 IP 和公网 IP 一一对应，这限制了网络中并发接入的主机数。现代 NAT 技术引入了端口号，使得多个内部主机可以共享一个公网 IP 地址，这种技术称为网络地址与端口转换（NAPT）。

![NAT 工作原理](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/2719067e-b299-4639-9065-bed6729dbf0b.png)

## 路由器的结构

路由器可从功能上分为路由选择与分组转发。分组转发的结构主要由以下三部分组成：

- **交换结构**：负责内部数据交换。
- **输入端口**：接收来的数据包，并处理相应的协议。
- **输出端口**：负责将数据包转发到下一个网络。

![路由器结构示意图](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/c3369072-c740-43b0-b276-202bd1d3960d.jpg)

## 路由器分组转发流程

路由器接收数据报的处理流程如下：

1. 从数据报的首部提取目的 IP 地址 D，解析得到目的网络地址 N。
2. 如果 N 是路由器直接相连的网络地址，则直接将数据报交付给相应主机。
3. 如果路由表中有目的地址为 D 的特定主机路由，则将数据报发送给相应的下一跳路由器。
4. 如果路由表中有到达网络 N 的路由，仍然将数据报发送给相应的下一跳路由器。
5. 如果路由表中有默认路由，就将数据报发送至默认路由器。
6. 如果所有路由策略均不满足，则报告转发出错。

![路由器转发流程示意图](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1ab49e39-012b-4383-8284-26570987e3c4.jpg)

## 路由选择协议

路由选择协议负责在动态变化的网络拓扑与流量中决定数据报的转发路径。整个互联网被划分为多个自治系统（AS），每个 AS 可以使用不同的路由选择协议。

路由选择协议大致可以分为两类：

- **内部网关协议**：RIP 和 OSPF
- **外部网关协议**：BGP

### 1. 内部网关协议 RIP

RIP（Routing Information Protocol，路由信息协议）是一种基于距离向量的协议。距离指的是跳数，直接相连的路由器跳数为 1，而最大跳数为 15，超过 15 的网络被视为不可达。

RIP 的工作原理是以固定时间间隔与邻居路由器交换路由表，通过多次交换，在整个 AS 中传播最新的路由信息，确保每个路由器能够知道如何到达各网络的最短路径。

### 2. 内部网关协议 OSPF

OSPF（Open Shortest Path First，开放最短路径优先）是为克服 RIP 的缺点而开发的协议。OSPF 使用洪泛法向整个自治系统的路由器发送信息，信息内容包括与邻居路由器的链路状态，而不是简单的路由表。

OSPF 具有多个优点，如收敛速度快、能够处理大型网络、支持更复杂的度量方式等。

### 3. 外部网关协议 BGP

BGP（Border Gateway Protocol，边界网关协议）主要用于自治系统之间的路由选择。其复杂性主要来源于以下几点：

- 互联网规模庞大；
- 不同 AS 内部使用不同的路由协议，路径度量难以统一；
- 路由选择需考虑不同的网络策略。

BGP 向较邻的 BGP 节点之间建立 TCP 连接以交换路由信息。

![BGP 路由协议示意图](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/9cd0ae20-4fb5-4017-a000-f7d3a0eb3529.png)

通过对以上协议流程的理解，可以更好地设计和管理网络结构以及网络性能。